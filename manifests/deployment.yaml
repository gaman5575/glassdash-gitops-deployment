apiVersion: apps/v1
kind: Deployment
metadata:
  name: glassdash
  namespace: glassdash
spec:
  replicas: 1 # Set to 2 for full rolling updates + higher availability
  selector:
    matchLabels:
      app: glassdash
  template:
    metadata:
      labels:
        app: glassdash
    spec:
      volumes:
      - name: git-volume
        emptyDir: {}
      containers:
      - name: nginx
        image: nginx:alpine
        ports:
        - containerPort: 80
        volumeMounts:
        - name: git-volume
          mountPath: /usr/share/nginx/html
          subPath: synced-repo/public # Serves your public/ files directly at root URL
      - name: git-sync
        image: registry.k8s.io/git-sync/git-sync:v4.0.0 # Proven stable tag (avoids pull errors)
        args:
        - --repo=https://github.com/gaman5575/glassdash-gitops-deployment.git
        - --branch=main
        - --depth=1
        - --wait=30 # Sync every 30 seconds
        - --root=/git
        - --dest=synced-repo # Syncs full repo to /git/synced-repo (includes public/)
        - --verbose # Logs details for debugging
        - --sync-hook-command=/bin/sh -c "echo 'Sync complete at $(date)' > /git/synced-repo/public/sync-log.txt" # Creates visible log file
        volumeMounts:
        - name: git-volume
          mountPath: /git
        securityContext:
          runAsUser: 65533
