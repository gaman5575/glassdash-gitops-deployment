apiVersion: apps/v1
kind: Deployment
metadata:
  name: glassdash
  namespace: glassdash
spec:
  replicas: 1  # Set to 2 for full rolling updates + availability
  selector:
    matchLabels:
      app: glassdash
  template:
    metadata:
      labels:
        app: glassdash
    spec:
      volumes:
      - name: html-volume
        emptyDir: {}
      containers:
      - name: nginx
        image: nginx:alpine
        ports:
        - containerPort: 80
        volumeMounts:
        - name: html-volume
          mountPath: /usr/share/nginx/html
      - name: git-sync-sidecar
        image: alpine:latest  # Full alpine for apk install
        command: ["/bin/sh", "-c"]
        args:
        - |
          # Install git and rsync once
          apk add --no-cache git rsync

          REPO_DIR="/repo"
          HTML_DIR="/html"
          INTERVAL=30

          # Initial clone if repo doesn't exist
          if [ ! -d "$REPO_DIR/.git" ]; then
            git clone --depth 1 https://github.com/gaman5575/glassdash-gitops-deployment.git "$REPO_DIR"
          fi

          # Initial sync
          rsync -a --delete "$REPO_DIR/public/" "$HTML_DIR/"
          echo "Initial sync complete at $(date)" > "$HTML_DIR/sync-log.txt"

          # Continuous sync loop
          while true; do
            cd "$REPO_DIR"
            git pull origin main --depth=1
            rsync -a --delete "$REPO_DIR/public/" "$HTML_DIR/"
            echo "Sync complete at $(date)" >> "$HTML_DIR/sync-log.txt"
            sleep $INTERVAL
          done
        volumeMounts:
        - name: html-volume
          mountPath: /html
        - name: repo-storage
          mountPath: /repo
      volumes:
      - name: html-volume
        emptyDir: {}
      - name: repo-storage
        emptyDir: {}