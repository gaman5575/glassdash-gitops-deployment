apiVersion: apps/v1
kind: Deployment
metadata:
  name: glassdash
  namespace: glassdash
spec:
  replicas: 1
  selector:
    matchLabels:
      app: glassdash
  template:
    metadata:
      labels:
        app: glassdash
    spec:
      volumes:
      - name: html-volume
        emptyDir: {}
      - name: repo-storage
        emptyDir: {}
      containers:
      - name: nginx
        image: nginx:alpine
        ports:
        - containerPort: 80
        volumeMounts:
        - name: html-volume
          mountPath: /usr/share/nginx/html
      - name: git-sync-sidecar
        image: alpine/git:latest
        command: ["/bin/sh", "-c"]
        args:
        - |
          REPO_DIR="/repo"
          HTML_DIR="/html"
          INTERVAL=30

          echo "Starting Git sync sidecar..."

          # Initial clone if repo not present
          if [ ! -d "$REPO_DIR/.git" ]; then
            echo "Cloning repository..."
            git clone --depth 1 https://github.com/gaman5575/glassdash-gitops-deployment.git "$REPO_DIR"
          fi

          # Function to sync files
          sync_files() {
            echo "Syncing files at $(date)..."
            rm -rf "$HTML_DIR"/*
            cp -r "$REPO_DIR/public"/* "$HTML_DIR"/ || echo "Copy failed - check paths"
            echo "Sync complete" >> "$HTML_DIR/sync-log.txt"
          }

          # Initial sync
          sync_files

          # Continuous loop
          while true; do
            cd "$REPO_DIR"
            echo "Pulling latest changes..."
            git pull origin main --depth=1 || echo "Git pull failed"
            sync_files
            sleep $INTERVAL
          done
        volumeMounts:
        - name: html-volume
          mountPath: /html
        - name: repo-storage
          mountPath: /repo