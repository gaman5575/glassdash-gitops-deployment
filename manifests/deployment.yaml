apiVersion: apps/v1
kind: Deployment
metadata:
  name: glassdash
  namespace: glassdash
spec:
  replicas: 1  # Increase to 2 for rolling updates on manifest changes
  selector:
    matchLabels:
      app: glassdash
  template:
    metadata:
      labels:
        app: glassdash
    spec:
      volumes:
      - name: html-volume
        emptyDir: {}
      initContainers:
      - name: initial-clone
        image: alpine/git:latest
        command: ["/bin/sh", "-c"]
        args:
        - |
          git clone --depth 1 https://github.com/gaman5575/glassdash-gitops-deployment.git /repo &&
          rsync -a /repo/public/ /html/ &&
          echo "Initial clone complete at $(date)" > /html/sync-log.txt
        volumeMounts:
        - name: html-volume
          mountPath: /html
      containers:
      - name: nginx
        image: nginx:alpine
        ports:
        - containerPort: 80
        volumeMounts:
        - name: html-volume
          mountPath: /usr/share/nginx/html
      - name: git-sync-sidecar
        image: alpine/git:latest
        command: ["/bin/sh", "-c"]
        args:
        - |
          REPO_DIR="/repo"
          HTML_DIR="/html"
          INTERVAL=30

          # Initial setup if needed
          if [ ! -d "$REPO_DIR" ]; then
            git clone --depth 1 https://github.com/gaman5575/glassdash-gitops-deployment.git "$REPO_DIR"
            rsync -a --delete "$REPO_DIR/public/" "$HTML_DIR/"
          fi

          # Continuous loop
          while true; do
            cd "$REPO_DIR"
            git pull origin main --depth=1
            rsync -a --delete "$REPO_DIR/public/" "$HTML_DIR/"
            echo "Sync complete at $(date)" >> "$HTML_DIR/sync-log.txt"
            sleep $INTERVAL
          done
        volumeMounts:
        - name: html-volume
          mountPath: /html
        - name: repo-storage  # Separate volume for repo to avoid conflicts
          mountPath: /repo
      volumes:
      - name: html-volume
        emptyDir: {}
      - name: repo-storage
        emptyDir: {}